{% extends "base.html" %}

{% block title %}ManualStudio - 動画アップロード{% endblock %}

{% block content %}
<div class="card">
    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">動画をアップロード</h2>
        <a href="/jobs" class="btn">ジョブ一覧</a>
    </div>
    <p class="mb-4">画面録画（mp4/mov）をアップロードすると、操作マニュアル（PPTX）が自動生成されます。</p>

    <!-- Upload Mode Toggle -->
    <div class="form-group" style="margin-bottom: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="batch-mode" style="width: auto;">
            <span>バッチモード（複数ファイルを一括処理）</span>
        </label>
    </div>

    <form id="upload-form" action="/api/jobs" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="video_file">動画ファイル *</label>
            <input type="file" id="video_file" name="video_file" accept=".mp4,.mov,.avi,.mkv,.webm" required>
            <small id="file-hint">対応形式: MP4, MOV, AVI, MKV, WebM（最大{{ max_video_size_mb }}MB、{{ max_video_minutes }}分）</small>
        </div>

        <!-- Single upload fields -->
        <div id="single-upload-fields">
            <div class="flex">
                <div class="flex-1 form-group">
                    <label for="title">タイトル</label>
                    <input type="text" id="title" name="title" placeholder="例: 経費精算システム操作手順">
                </div>

                <div class="flex-1 form-group">
                    <label for="language">言語</label>
                    <select id="language" name="language">
                        <option value="ja" selected>日本語</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="goal">マニュアルの目的</label>
                <textarea id="goal" name="goal" placeholder="例: 新入社員向けに経費精算の申請方法を説明する"></textarea>
            </div>
        </div>

        <!-- Batch upload fields (hidden by default) -->
        <div id="batch-upload-fields" style="display: none;">
            <div class="flex">
                <div class="flex-1 form-group">
                    <label for="title_prefix">タイトル接頭辞</label>
                    <input type="text" id="title_prefix" name="title_prefix" placeholder="例: 研修マニュアル">
                    <small>各ジョブのタイトルは「接頭辞 - ファイル名」になります</small>
                </div>

                <div class="flex-1 form-group">
                    <label for="batch_language">言語</label>
                    <select id="batch_language" name="language">
                        <option value="ja" selected>日本語</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="batch_goal">共通の目的</label>
                <textarea id="batch_goal" name="goal" placeholder="すべてのジョブに適用される目的"></textarea>
            </div>

            <div id="selected-files" style="margin-bottom: 1rem;"></div>
        </div>

        <button type="submit" class="btn btn-primary" id="submit-btn">
            アップロードして生成開始
        </button>
    </form>

    <div id="upload-progress" style="display: none;">
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <p id="progress-text">アップロード中...</p>
    </div>

    <!-- Batch result -->
    <div id="batch-result" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
        <h3 style="margin-top: 0;">バッチ処理結果</h3>
        <div id="batch-result-content"></div>
        <a href="/jobs" class="btn btn-primary" style="margin-top: 1rem;">ジョブ一覧を見る</a>
    </div>
</div>

<div class="card">
    <h2>使い方</h2>
    <ol style="margin-left: 20px;">
        <li>画面操作を録画したMP4/MOVファイルを用意します</li>
        <li>上のフォームからファイルをアップロードします
            <ul style="margin-left: 20px; margin-top: 8px;">
                <li><strong>単一モード</strong>: 1つの動画をアップロード</li>
                <li><strong>バッチモード</strong>: 複数の動画を一括アップロード（最大10件）</li>
            </ul>
        </li>
        <li>自動的に以下の処理が行われます：
            <ul style="margin-left: 20px; margin-top: 8px;">
                <li>音声の文字起こし</li>
                <li>画面転換の検出</li>
                <li>操作手順の構造化</li>
                <li>PowerPointスライドの生成</li>
            </ul>
        </li>
        <li>完了後、PPTXファイルをダウンロードできます</li>
    </ol>
</div>
{% endblock %}

{% block extra_js %}
<script>
const batchModeCheckbox = document.getElementById('batch-mode');
const videoFileInput = document.getElementById('video_file');
const singleFields = document.getElementById('single-upload-fields');
const batchFields = document.getElementById('batch-upload-fields');
const selectedFilesDiv = document.getElementById('selected-files');
const fileHint = document.getElementById('file-hint');
const submitBtn = document.getElementById('submit-btn');

// Toggle batch mode
batchModeCheckbox.addEventListener('change', function() {
    if (this.checked) {
        videoFileInput.setAttribute('multiple', 'multiple');
        videoFileInput.name = 'video_files';
        singleFields.style.display = 'none';
        batchFields.style.display = 'block';
        fileHint.textContent = '複数ファイルを選択できます（最大10件）';
        submitBtn.textContent = 'バッチアップロード開始';
    } else {
        videoFileInput.removeAttribute('multiple');
        videoFileInput.name = 'video_file';
        singleFields.style.display = 'block';
        batchFields.style.display = 'none';
        fileHint.textContent = '対応形式: MP4, MOV, AVI, MKV, WebM（最大{{ max_video_size_mb }}MB、{{ max_video_minutes }}分）';
        submitBtn.textContent = 'アップロードして生成開始';
        selectedFilesDiv.innerHTML = '';
    }
});

// Show selected files in batch mode
videoFileInput.addEventListener('change', function() {
    if (batchModeCheckbox.checked && this.files.length > 0) {
        const fileList = Array.from(this.files).map(f =>
            `<li>${f.name} (${(f.size / 1024 / 1024).toFixed(1)}MB)</li>`
        ).join('');
        selectedFilesDiv.innerHTML = `<strong>選択されたファイル (${this.files.length}件):</strong><ul style="margin: 0.5rem 0 0 1.5rem;">${fileList}</ul>`;
    } else {
        selectedFilesDiv.innerHTML = '';
    }
});

document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = this;
    const progressDiv = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const batchResult = document.getElementById('batch-result');
    const batchResultContent = document.getElementById('batch-result-content');

    submitBtn.disabled = true;
    progressDiv.style.display = 'block';
    batchResult.style.display = 'none';

    const formData = new FormData(form);
    const isBatchMode = batchModeCheckbox.checked;
    const endpoint = isBatchMode ? '/api/jobs/batch' : '/api/jobs';

    try {
        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressFill.style.width = percent + '%';
                progressText.textContent = `アップロード中... ${percent}%`;
            }
        });

        xhr.addEventListener('load', function() {
            if (xhr.status === 201) {
                const response = JSON.parse(xhr.responseText);

                if (isBatchMode) {
                    // Show batch result
                    progressDiv.style.display = 'none';
                    batchResult.style.display = 'block';

                    let html = `<p>作成成功: ${response.total_created}件 / エラー: ${response.total_errors}件</p>`;

                    if (response.created.length > 0) {
                        html += '<h4>作成されたジョブ:</h4><ul>';
                        response.created.forEach(job => {
                            html += `<li><a href="/jobs/${job.job_id}">${job.file}</a> - ${job.status}</li>`;
                        });
                        html += '</ul>';
                    }

                    if (response.errors.length > 0) {
                        html += '<h4 style="color: #dc3545;">エラー:</h4><ul>';
                        response.errors.forEach(err => {
                            html += `<li>${err.file}: ${err.error}</li>`;
                        });
                        html += '</ul>';
                    }

                    batchResultContent.innerHTML = html;
                    submitBtn.disabled = false;
                } else {
                    progressText.textContent = 'アップロード完了！リダイレクト中...';
                    window.location.href = '/jobs/' + response.job_id;
                }
            } else {
                const error = JSON.parse(xhr.responseText);
                alert('エラー: ' + (error.detail || error.message || 'アップロードに失敗しました'));
                submitBtn.disabled = false;
                progressDiv.style.display = 'none';
            }
        });

        xhr.addEventListener('error', function() {
            alert('ネットワークエラーが発生しました');
            submitBtn.disabled = false;
            progressDiv.style.display = 'none';
        });

        xhr.open('POST', endpoint);
        xhr.send(formData);

    } catch (error) {
        alert('エラー: ' + error.message);
        submitBtn.disabled = false;
        progressDiv.style.display = 'none';
    }
});
</script>
{% endblock %}
